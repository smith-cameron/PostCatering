name: Deploy EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-ec2-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy To EC2
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        env:
          EC2_SSH_HOST: ${{ secrets.EC2_SSH_HOST }}
          EC2_SSH_USER: ${{ secrets.EC2_SSH_USER }}
          EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          [ -n "${EC2_SSH_HOST:-}" ] || { echo "Missing secret: EC2_SSH_HOST"; exit 1; }
          [ -n "${EC2_SSH_USER:-}" ] || { echo "Missing secret: EC2_SSH_USER"; exit 1; }
          [ -n "${EC2_SSH_PRIVATE_KEY:-}" ] || { echo "Missing secret: EC2_SSH_PRIVATE_KEY"; exit 1; }

      - name: Prepare SSH key
        env:
          EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.ssh"
          printf '%s\n' "$EC2_SSH_PRIVATE_KEY" > "$HOME/.ssh/id_ed25519"
          chmod 600 "$HOME/.ssh/id_ed25519"

      - name: Add host key
        env:
          EC2_SSH_HOST: ${{ secrets.EC2_SSH_HOST }}
        run: |
          set -euo pipefail
          ssh-keyscan -H "$EC2_SSH_HOST" >> "$HOME/.ssh/known_hosts"

      - name: Upload deploy script
        env:
          EC2_SSH_HOST: ${{ secrets.EC2_SSH_HOST }}
          EC2_SSH_USER: ${{ secrets.EC2_SSH_USER }}
        run: |
          set -euo pipefail
          scp -i "$HOME/.ssh/id_ed25519" ops/deploy-ec2.sh "$EC2_SSH_USER@$EC2_SSH_HOST:/tmp/postcatering-deploy.sh"

      - name: Run deploy script on EC2
        env:
          EC2_SSH_HOST: ${{ secrets.EC2_SSH_HOST }}
          EC2_SSH_USER: ${{ secrets.EC2_SSH_USER }}
          EC2_DEPLOY_PATH: ${{ secrets.EC2_DEPLOY_PATH }}
          EC2_API_SERVICE: ${{ secrets.EC2_API_SERVICE }}
          EC2_HEALTH_URL: ${{ secrets.EC2_HEALTH_URL }}
          GITHUB_BRANCH: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          APP_DIR="${EC2_DEPLOY_PATH:-/home/ubuntu/PostCatering}"
          API_SERVICE="${EC2_API_SERVICE:-postcatering-api}"
          HEALTH_URL="${EC2_HEALTH_URL:-http://127.0.0.1/api/health}"

          ssh -i "$HOME/.ssh/id_ed25519" "$EC2_SSH_USER@$EC2_SSH_HOST" \
            "chmod +x /tmp/postcatering-deploy.sh && APP_DIR='$APP_DIR' BRANCH='$GITHUB_BRANCH' API_SERVICE='$API_SERVICE' HEALTH_URL='$HEALTH_URL' /tmp/postcatering-deploy.sh && rm -f /tmp/postcatering-deploy.sh"
